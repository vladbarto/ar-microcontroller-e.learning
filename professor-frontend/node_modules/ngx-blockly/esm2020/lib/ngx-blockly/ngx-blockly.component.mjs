import { Component, ElementRef, EventEmitter, HostListener, Input, Output, ViewChild } from '@angular/core';
import { NgxBlocklyGenerator } from './ngx-blockly.config';
import * as Blockly from 'blockly/core';
import { dartGenerator } from 'blockly/dart';
import { luaGenerator } from 'blockly/lua';
import { javascriptGenerator } from 'blockly/javascript';
import { phpGenerator } from 'blockly/php';
import { pythonGenerator } from 'blockly/python';
import * as i0 from "@angular/core";
export class NgxBlocklyComponent {
    constructor() {
        this.config = {};
        this.customBlocks = [];
        this.readOnly = false;
        this.workspaceCreate = new EventEmitter();
        this.workspaceChange = new EventEmitter();
        this.toolboxChange = new EventEmitter();
        this.dartCode = new EventEmitter();
        this.javascriptCode = new EventEmitter();
        this.luaCode = new EventEmitter();
        this.phpCode = new EventEmitter();
        this.pythonCode = new EventEmitter();
        this.xmlCode = new EventEmitter();
        this._finishedLoading = false;
    }
    static initCustomBlocks(blocks) {
        if (blocks) {
            for (const customBlock of blocks) {
                Blockly.Blocks[customBlock.type] = {
                    init: function () {
                        const block = new customBlock.class(customBlock.type, customBlock.blockMutator, ...customBlock.args);
                        block.init(this);
                        this.mixin({
                            blockInstance: block
                        });
                    }
                };
                pythonGenerator[customBlock.type] = function (b) {
                    return b.blockInstance.toPythonCode(b);
                };
                dartGenerator[customBlock.type] = function (b) {
                    return b.blockInstance.toDartCode(b);
                };
                javascriptGenerator[customBlock.type] = function (b) {
                    return b.blockInstance.toJavaScriptCode(b);
                };
                luaGenerator[customBlock.type] = function (b) {
                    return b.blockInstance.toLuaCode(b);
                };
                phpGenerator[customBlock.type] = function (b) {
                    return b.blockInstance.toPHPCode(b);
                };
                if (customBlock.blockMutator) {
                    const mutator_mixin = {
                        mutationToDom: function () {
                            return customBlock.blockMutator.mutationToDom.call(customBlock.blockMutator, this);
                        },
                        domToMutation: function (xmlElement) {
                            customBlock.blockMutator.domToMutation.call(customBlock.blockMutator, this, xmlElement);
                        },
                        saveExtraState: function () {
                            return customBlock.blockMutator.saveExtraState.call(customBlock.blockMutator);
                        },
                        loadExtraState: function (state) {
                            customBlock.blockMutator.loadExtraState.call(customBlock.blockMutator, state);
                        }
                    };
                    if (customBlock.blockMutator.blockList && customBlock.blockMutator.blockList.length > 0) {
                        mutator_mixin.decompose = function (workspace) {
                            return customBlock.blockMutator.decompose.call(customBlock.blockMutator, this, workspace);
                        };
                        mutator_mixin.compose = function (topBlock) {
                            customBlock.blockMutator.compose.call(customBlock.blockMutator, this, topBlock);
                        };
                        mutator_mixin.saveConnections = function (containerBlock) {
                            customBlock.blockMutator.saveConnections.call(customBlock.blockMutator, this, containerBlock);
                        };
                    }
                    Blockly.Extensions.unregister(customBlock.blockMutator.name);
                    Blockly.Extensions.registerMutator(customBlock.blockMutator.name, mutator_mixin, function () {
                        customBlock.blockMutator.afterBlockInit.call(customBlock.blockMutator, this);
                    }, customBlock.blockMutator.blockList);
                }
            }
        }
    }
    ngOnInit() {
        NgxBlocklyComponent.initCustomBlocks(this.customBlocks);
    }
    ngAfterViewInit() {
        const readOnly = this.config.readOnly || this.readOnly;
        this.config.readOnly = false;
        this.workspace = Blockly.inject(this.primaryContainer.nativeElement, this.config);
        this.workspace.addChangeListener(this._onWorkspaceChange.bind(this));
        this.workspace.fireChangeListener(new Blockly.Events.FinishedLoading());
        this.workspaceCreate.emit(this.workspace);
        this.resize();
        if (readOnly) {
            this.setReadonly(true);
            this.config.readOnly = true;
        }
    }
    ngOnChanges(changes) {
        // skip this if the change comes before we are initialized
        if (changes.readOnly && this._secondaryWorkspace) {
            this.setReadonly(changes.readOnly.currentValue);
        }
    }
    ngOnDestroy() {
        if (this.workspace) {
            this.workspace.dispose();
        }
        if (this._secondaryWorkspace) {
            this._secondaryWorkspace.dispose();
        }
    }
    onResize(event) {
        clearTimeout(this._resizeTimeout);
        this._resizeTimeout = setTimeout(() => this.resize(), 200);
    }
    /**
     * Generate code for all blocks in the workspace to the specified output.
     * @param workspaceId Workspace to generate code from.
     */
    workspaceToCode(workspaceId) {
        for (const generator of this.config.generators) {
            switch (generator) {
                case NgxBlocklyGenerator.DART:
                    this.dartCode.emit(dartGenerator.workspaceToCode(Blockly.Workspace.getById(workspaceId)));
                    break;
                case NgxBlocklyGenerator.LUA:
                    this.luaCode.emit(luaGenerator.workspaceToCode(Blockly.Workspace.getById(workspaceId)));
                    break;
                case NgxBlocklyGenerator.JAVASCRIPT:
                    this.javascriptCode.emit(javascriptGenerator.workspaceToCode(Blockly.Workspace.getById(workspaceId)));
                    break;
                case NgxBlocklyGenerator.PHP:
                    this.phpCode.emit(phpGenerator.workspaceToCode(Blockly.Workspace.getById(workspaceId)));
                    break;
                case NgxBlocklyGenerator.PYTHON:
                    this.pythonCode.emit(pythonGenerator.workspaceToCode(Blockly.Workspace.getById(workspaceId)));
                    break;
                case NgxBlocklyGenerator.XML:
                    this.xmlCode.emit(Blockly.Xml.domToPrettyText(Blockly.Xml.workspaceToDom(Blockly.Workspace.getById(workspaceId))));
                    break;
            }
        }
    }
    /**
     * Converts a DOM structure into properly indented text.
     * @return Text representation.
     */
    toXml() {
        return Blockly.Xml.domToPrettyText(Blockly.Xml.workspaceToDom(this.workspace));
    }
    /**
     * Clear the given workspace then decode an XML DOM and
     * create blocks on the workspace.
     * @param xml XML DOM..
     */
    fromXml(xml) {
        this._finishedLoading = false;
        Blockly.Xml.clearWorkspaceAndLoadFromXml(Blockly.Xml.textToDom(xml), this.workspace);
        if (this._secondaryWorkspace) {
            Blockly.Xml.clearWorkspaceAndLoadFromXml(Blockly.Xml.textToDom(xml), this._secondaryWorkspace);
        }
    }
    /**
     * Decode an XML DOM and create blocks on the workspace. Position the new
     * blocks immediately below prior blocks, aligned by their starting edge.
     * @param xml The XML DOM.
     */
    appendFromXml(xml) {
        Blockly.Xml.appendDomToWorkspace(Blockly.Xml.textToDom(xml), this.workspace);
        if (this._secondaryWorkspace) {
            Blockly.Xml.appendDomToWorkspace(Blockly.Xml.textToDom(xml), this._secondaryWorkspace);
        }
    }
    /**
     * Dispose of all blocks in workspace, with an optimization to prevent resizes.
     */
    clear() {
        if (this.workspace) {
            this.workspace.clear();
        }
    }
    /**
     * Clear the undo/redo stacks.
     */
    clearUndo() {
        if (this.workspace) {
            this.workspace.clearUndo();
        }
    }
    /**
     * Clear the reference to the current gesture.
     */
    clearGesture() {
        if (this.workspace) {
            this.workspace.clearGesture();
        }
    }
    /**
     * Clear search input and result set.
     */
    clearSearch() {
        if (this.workspace) {
            const toolbox = this.workspace.getToolbox();
            if (toolbox && typeof toolbox.clearSearch === 'function') {
                toolbox.clearSearch();
            }
        }
    }
    /**
     * Size the workspace when the contents change. This also updates
     * scrollbars accordingly.
     */
    resize() {
        if (this.workspace) {
            Blockly.svgResize(this.workspace);
        }
        if (this._secondaryWorkspace) {
            Blockly.svgResize(this._secondaryWorkspace);
        }
    }
    setReadonly(readOnly) {
        this.readOnly = readOnly;
        if (readOnly) {
            this.secondaryContainer.nativeElement.classList.remove('hidden');
            if (!this._secondaryWorkspace) {
                const config = { ...this.config };
                config.readOnly = true;
                this._secondaryWorkspace = Blockly.inject(this.secondaryContainer.nativeElement, config);
            }
            Blockly.Xml.clearWorkspaceAndLoadFromXml(Blockly.Xml.textToDom(this.toXml()), this._secondaryWorkspace);
            Blockly.svgResize(this._secondaryWorkspace);
        }
        else {
            if (this._secondaryWorkspace) {
                this.secondaryContainer.nativeElement.classList.add('hidden');
            }
        }
    }
    highlightBlock(blockId) {
        if (this.workspace) {
            this.workspace.highlightBlock(blockId);
        }
        if (this._secondaryWorkspace) {
            this._secondaryWorkspace.highlightBlock(blockId);
        }
    }
    _onWorkspaceChange(event) {
        this.workspaceChange.emit(event);
        if (event.type === Blockly.Events.FINISHED_LOADING) {
            this._finishedLoading = true;
        }
        if (this._finishedLoading) {
            if (event instanceof Blockly.Events.BlockBase ||
                event instanceof Blockly.Events.VarBase ||
                event instanceof Blockly.Events.CommentBase) {
                this.workspaceToCode(event.workspaceId);
            }
            if (event.type === Blockly.Events.TOOLBOX_ITEM_SELECT) {
                this.toolboxChange.emit(event);
            }
        }
    }
}
NgxBlocklyComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.12", ngImport: i0, type: NgxBlocklyComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });
NgxBlocklyComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.2.12", type: NgxBlocklyComponent, selector: "ngx-blockly", inputs: { config: "config", customBlocks: "customBlocks", readOnly: "readOnly" }, outputs: { workspaceCreate: "workspaceCreate", workspaceChange: "workspaceChange", toolboxChange: "toolboxChange", dartCode: "dartCode", javascriptCode: "javascriptCode", luaCode: "luaCode", phpCode: "phpCode", pythonCode: "pythonCode", xmlCode: "xmlCode" }, host: { listeners: { "window:resize": "onResize($event)" } }, viewQueries: [{ propertyName: "primaryContainer", first: true, predicate: ["primaryContainer"], descendants: true }, { propertyName: "secondaryContainer", first: true, predicate: ["secondaryContainer"], descendants: true }], usesOnChanges: true, ngImport: i0, template: "<div id=\"blockly-wrapper\" class=\"blockly-wrapper\">\n    <div #primaryContainer class=\"blockly\"></div>\n    <div #secondaryContainer class=\"blockly hidden\"></div>\n</div>\n", styles: [".blockly-wrapper{width:100%;height:100%}.blockly{position:absolute;width:100%;min-width:100%;height:100%;min-height:100%}.blockly{z-index:1}.blockly.hidden{display:none;z-index:0}::ng-deep .blockly .blocklyToolboxDiv{display:flex;flex-direction:column;justify-content:flex-start;overflow:auto}::ng-deep .blockly .blocklyToolboxDiv .blocklyTreeRoot{overflow-x:visible;overflow-y:auto;flex:1}::ng-deep .blockly .blocklyToolboxDiv input.searchbar{border:none;background-color:transparent;font-size:16px;padding:8px 25px 4px;border-bottom:1px solid #ccc;background:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0Ij48cGF0aCBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTE1LjUgMTRoLS43OWwtLjI4LS4yN0MxNS40MSAxMi41OSAxNiAxMS4xMSAxNiA5LjUgMTYgNS45MSAxMy4wOSAzIDkuNSAzUzMgNS45MSAzIDkuNSA1LjkxIDE2IDkuNSAxNmMxLjYxIDAgMy4wOS0uNTkgNC4yMy0xLjU3bC4yNy4yOHYuNzlsNSA0Ljk5TDIwLjQ5IDE5bC00Ljk5LTV6bS02IDBDNy4wMSAxNCA1IDExLjk5IDUgOS41UzcuMDEgNSA5LjUgNSAxNCA3LjAxIDE0IDkuNSAxMS45OSAxNCA5LjUgMTR6Ii8+PC9zdmc+) no-repeat right center;min-width:120px}::ng-deep .blockly .blocklyToolboxDiv input.searchbar:focus{outline:none}\n"] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.12", ngImport: i0, type: NgxBlocklyComponent, decorators: [{
            type: Component,
            args: [{ selector: 'ngx-blockly', template: "<div id=\"blockly-wrapper\" class=\"blockly-wrapper\">\n    <div #primaryContainer class=\"blockly\"></div>\n    <div #secondaryContainer class=\"blockly hidden\"></div>\n</div>\n", styles: [".blockly-wrapper{width:100%;height:100%}.blockly{position:absolute;width:100%;min-width:100%;height:100%;min-height:100%}.blockly{z-index:1}.blockly.hidden{display:none;z-index:0}::ng-deep .blockly .blocklyToolboxDiv{display:flex;flex-direction:column;justify-content:flex-start;overflow:auto}::ng-deep .blockly .blocklyToolboxDiv .blocklyTreeRoot{overflow-x:visible;overflow-y:auto;flex:1}::ng-deep .blockly .blocklyToolboxDiv input.searchbar{border:none;background-color:transparent;font-size:16px;padding:8px 25px 4px;border-bottom:1px solid #ccc;background:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0Ij48cGF0aCBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTE1LjUgMTRoLS43OWwtLjI4LS4yN0MxNS40MSAxMi41OSAxNiAxMS4xMSAxNiA5LjUgMTYgNS45MSAxMy4wOSAzIDkuNSAzUzMgNS45MSAzIDkuNSA1LjkxIDE2IDkuNSAxNmMxLjYxIDAgMy4wOS0uNTkgNC4yMy0xLjU3bC4yNy4yOHYuNzlsNSA0Ljk5TDIwLjQ5IDE5bC00Ljk5LTV6bS02IDBDNy4wMSAxNCA1IDExLjk5IDUgOS41UzcuMDEgNSA5LjUgNSAxNCA3LjAxIDE0IDkuNSAxMS45OSAxNCA5LjUgMTR6Ii8+PC9zdmc+) no-repeat right center;min-width:120px}::ng-deep .blockly .blocklyToolboxDiv input.searchbar:focus{outline:none}\n"] }]
        }], propDecorators: { config: [{
                type: Input
            }], customBlocks: [{
                type: Input
            }], readOnly: [{
                type: Input
            }], workspaceCreate: [{
                type: Output
            }], workspaceChange: [{
                type: Output
            }], toolboxChange: [{
                type: Output
            }], dartCode: [{
                type: Output
            }], javascriptCode: [{
                type: Output
            }], luaCode: [{
                type: Output
            }], phpCode: [{
                type: Output
            }], pythonCode: [{
                type: Output
            }], xmlCode: [{
                type: Output
            }], primaryContainer: [{
                type: ViewChild,
                args: ['primaryContainer']
            }], secondaryContainer: [{
                type: ViewChild,
                args: ['secondaryContainer']
            }], onResize: [{
                type: HostListener,
                args: ['window:resize', ['$event']]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWJsb2NrbHkuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWJsb2NrbHkvc3JjL2xpYi9uZ3gtYmxvY2tseS9uZ3gtYmxvY2tseS5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtYmxvY2tseS9zcmMvbGliL25neC1ibG9ja2x5L25neC1ibG9ja2x5LmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCxTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixZQUFZLEVBQ1osS0FBSyxFQUlMLE1BQU0sRUFFTixTQUFTLEVBQ1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFvQixtQkFBbUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRTdFLE9BQU8sS0FBSyxPQUFPLE1BQU0sY0FBYyxDQUFDO0FBRXhDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDN0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUMzQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7QUFPakQsTUFBTSxPQUFPLG1CQUFtQjtJQUxoQztRQU9rQixXQUFNLEdBQXFCLEVBQUUsQ0FBQztRQUM5QixpQkFBWSxHQUFrQixFQUFFLENBQUM7UUFDakMsYUFBUSxHQUFHLEtBQUssQ0FBQztRQUNoQixvQkFBZSxHQUF1QyxJQUFJLFlBQVksRUFBd0IsQ0FBQztRQUMvRixvQkFBZSxHQUFtRCxJQUFJLFlBQVksRUFBb0MsQ0FBQztRQUN2SCxrQkFBYSxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBQzNELGFBQVEsR0FB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c0JBQS9CLE1BQU07Z0JBQ1UsYUFBYTtzQkFBN0IsTUFBTTtnQkFDVSxRQUFRO3NCQUF4QixNQUFNO2dCQUNVLGNBQWM7c0JBQTlCLE1BQU07Z0JBQ1UsT0FBTztzQkFBdkIsTUFBTTtnQkFDVSxPQUFPO3NCQUF2QixNQUFNO2dCQUNVLFVBQVU7c0JBQTFCLE1BQU07Z0JBQ1UsT0FBTztzQkFBdkIsTUFBTTtnQkFFd0IsZ0JBQWdCO3NCQUE5QyxTQUFTO3VCQUFDLGtCQUFrQjtnQkFDSSxrQkFBa0I7c0JBQWxELFNBQVM7dUJBQUMsb0JBQW9CO2dCQTZHL0IsUUFBUTtzQkFEUCxZQUFZO3VCQUFDLGVBQWUsRUFBRSxDQUFDLFFBQVEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFmdGVyVmlld0luaXQsXG4gIENvbXBvbmVudCxcbiAgRWxlbWVudFJlZixcbiAgRXZlbnRFbWl0dGVyLFxuICBIb3N0TGlzdGVuZXIsXG4gIElucHV0LFxuICBPbkNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBPdXRwdXQsXG4gIFNpbXBsZUNoYW5nZSxcbiAgVmlld0NoaWxkXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTmd4QmxvY2tseUNvbmZpZywgTmd4QmxvY2tseUdlbmVyYXRvciB9IGZyb20gJy4vbmd4LWJsb2NrbHkuY29uZmlnJztcbmltcG9ydCB7IEN1c3RvbUJsb2NrIH0gZnJvbSAnLi9tb2RlbHMvY3VzdG9tLWJsb2NrJztcbmltcG9ydCAqIGFzIEJsb2NrbHkgZnJvbSAnYmxvY2tseS9jb3JlJztcbmltcG9ydCB7IE5neEJsb2NrbHlUb29sYm94IH0gZnJvbSAnLi9wbHVnaW5zL25neC1ibG9ja2x5LnRvb2xib3gnO1xuaW1wb3J0IHsgZGFydEdlbmVyYXRvciB9IGZyb20gJ2Jsb2NrbHkvZGFydCc7XG5pbXBvcnQgeyBsdWFHZW5lcmF0b3IgfSBmcm9tICdibG9ja2x5L2x1YSc7XG5pbXBvcnQgeyBqYXZhc2NyaXB0R2VuZXJhdG9yIH0gZnJvbSAnYmxvY2tseS9qYXZhc2NyaXB0JztcbmltcG9ydCB7IHBocEdlbmVyYXRvciB9IGZyb20gJ2Jsb2NrbHkvcGhwJztcbmltcG9ydCB7IHB5dGhvbkdlbmVyYXRvciB9IGZyb20gJ2Jsb2NrbHkvcHl0aG9uJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbmd4LWJsb2NrbHknLFxuICB0ZW1wbGF0ZVVybDogJy4vbmd4LWJsb2NrbHkuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9uZ3gtYmxvY2tseS5jb21wb25lbnQuY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgTmd4QmxvY2tseUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuXG4gIEBJbnB1dCgpIHB1YmxpYyBjb25maWc6IE5neEJsb2NrbHlDb25maWcgPSB7fTtcbiAgQElucHV0KCkgcHVibGljIGN1c3RvbUJsb2NrczogQ3VzdG9tQmxvY2tbXSA9IFtdO1xuICBASW5wdXQoKSBwdWJsaWMgcmVhZE9ubHkgPSBmYWxzZTtcbiAgQE91dHB1dCgpIHB1YmxpYyB3b3Jrc3BhY2VDcmVhdGU6IEV2ZW50RW1pdHRlcjxCbG9ja2x5LldvcmtzcGFjZVN2Zz4gPSBuZXcgRXZlbnRFbWl0dGVyPEJsb2NrbHkuV29ya3NwYWNlU3ZnPigpO1xuICBAT3V0cHV0KCkgcHVibGljIHdvcmtzcGFjZUNoYW5nZTogRXZlbnRFbWl0dGVyPEJsb2NrbHkuRXZlbnRzLkFic3RyYWN0RXZlbnRKc29uPiA9IG5ldyBFdmVudEVtaXR0ZXI8QmxvY2tseS5FdmVudHMuQWJzdHJhY3RFdmVudEpzb24+KCk7XG4gIEBPdXRwdXQoKSBwdWJsaWMgdG9vbGJveENoYW5nZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dCgpIHB1YmxpYyBkYXJ0Q29kZTogRXZlbnRFbWl0dGVyPHN0cmluZz4gPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcbiAgQE91dHB1dCgpIHB1YmxpYyBqYXZhc2NyaXB0Q29kZTogRXZlbnRFbWl0dGVyPHN0cmluZz4gPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcbiAgQE91dHB1dCgpIHB1YmxpYyBsdWFDb2RlOiBFdmVudEVtaXR0ZXI8c3RyaW5nPiA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xuICBAT3V0cHV0KCkgcHVibGljIHBocENvZGU6IEV2ZW50RW1pdHRlcjxzdHJpbmc+ID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XG4gIEBPdXRwdXQoKSBwdWJsaWMgcHl0aG9uQ29kZTogRXZlbnRFbWl0dGVyPHN0cmluZz4gPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcbiAgQE91dHB1dCgpIHB1YmxpYyB4bWxDb2RlOiBFdmVudEVtaXR0ZXI8c3RyaW5nPiA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xuXG4gIEBWaWV3Q2hpbGQoJ3ByaW1hcnlDb250YWluZXInKSBwcmltYXJ5Q29udGFpbmVyOiBFbGVtZW50UmVmO1xuICBAVmlld0NoaWxkKCdzZWNvbmRhcnlDb250YWluZXInKSBzZWNvbmRhcnlDb250YWluZXI6IEVsZW1lbnRSZWY7XG4gIHB1YmxpYyB3b3Jrc3BhY2U6IEJsb2NrbHkuV29ya3NwYWNlU3ZnO1xuICBwcml2YXRlIF9zZWNvbmRhcnlXb3Jrc3BhY2U6IEJsb2NrbHkuV29ya3NwYWNlU3ZnO1xuICBwcml2YXRlIF9yZXNpemVUaW1lb3V0O1xuICBwcml2YXRlIF9maW5pc2hlZExvYWRpbmcgPSBmYWxzZTtcblxuICBwdWJsaWMgc3RhdGljIGluaXRDdXN0b21CbG9ja3MoYmxvY2tzOiBDdXN0b21CbG9ja1tdKSB7XG4gICAgaWYgKGJsb2Nrcykge1xuICAgICAgZm9yIChjb25zdCBjdXN0b21CbG9jayBvZiBibG9ja3MpIHtcbiAgICAgICAgQmxvY2tseS5CbG9ja3NbY3VzdG9tQmxvY2sudHlwZV0gPSB7XG4gICAgICAgICAgaW5pdDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgY29uc3QgYmxvY2sgPSBuZXcgY3VzdG9tQmxvY2suY2xhc3MoY3VzdG9tQmxvY2sudHlwZSwgY3VzdG9tQmxvY2suYmxvY2tNdXRhdG9yLCAuLi5jdXN0b21CbG9jay5hcmdzKTtcbiAgICAgICAgICAgIGJsb2NrLmluaXQodGhpcyk7XG4gICAgICAgICAgICB0aGlzLm1peGluKHtcbiAgICAgICAgICAgICAgICBibG9ja0luc3RhbmNlOiBibG9ja1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgcHl0aG9uR2VuZXJhdG9yW2N1c3RvbUJsb2NrLnR5cGVdID0gZnVuY3Rpb24gKGIpIHtcbiAgICAgICAgICByZXR1cm4gYi5ibG9ja0luc3RhbmNlLnRvUHl0aG9uQ29kZShiKTtcbiAgICAgICAgfTtcbiAgICAgICAgZGFydEdlbmVyYXRvcltjdXN0b21CbG9jay50eXBlXSA9IGZ1bmN0aW9uIChiKSB7XG4gICAgICAgICAgcmV0dXJuIGIuYmxvY2tJbnN0YW5jZS50b0RhcnRDb2RlKGIpO1xuICAgICAgICB9O1xuICAgICAgICBqYXZhc2NyaXB0R2VuZXJhdG9yW2N1c3RvbUJsb2NrLnR5cGVdID0gZnVuY3Rpb24gKGIpIHtcbiAgICAgICAgICByZXR1cm4gYi5ibG9ja0luc3RhbmNlLnRvSmF2YVNjcmlwdENvZGUoYik7XG4gICAgICAgIH07XG4gICAgICAgIGx1YUdlbmVyYXRvcltjdXN0b21CbG9jay50eXBlXSA9IGZ1bmN0aW9uIChiKSB7XG4gICAgICAgICAgcmV0dXJuIGIuYmxvY2tJbnN0YW5jZS50b0x1YUNvZGUoYik7XG4gICAgICAgIH07XG4gICAgICAgIHBocEdlbmVyYXRvcltjdXN0b21CbG9jay50eXBlXSA9IGZ1bmN0aW9uIChiKSB7XG4gICAgICAgICAgcmV0dXJuIGIuYmxvY2tJbnN0YW5jZS50b1BIUENvZGUoYik7XG4gICAgICAgIH07XG4gICAgICAgIGlmIChjdXN0b21CbG9jay5ibG9ja011dGF0b3IpIHtcbiAgICAgICAgICBjb25zdCBtdXRhdG9yX21peGluOiBhbnkgPSB7XG4gICAgICAgICAgICBtdXRhdGlvblRvRG9tOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgIHJldHVybiBjdXN0b21CbG9jay5ibG9ja011dGF0b3IubXV0YXRpb25Ub0RvbS5jYWxsKGN1c3RvbUJsb2NrLmJsb2NrTXV0YXRvciwgdGhpcyk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZG9tVG9NdXRhdGlvbjogZnVuY3Rpb24gKHhtbEVsZW1lbnQ6IGFueSkge1xuICAgICAgICAgICAgICBjdXN0b21CbG9jay5ibG9ja011dGF0b3IuZG9tVG9NdXRhdGlvbi5jYWxsKGN1c3RvbUJsb2NrLmJsb2NrTXV0YXRvciwgdGhpcywgeG1sRWxlbWVudCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc2F2ZUV4dHJhU3RhdGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGN1c3RvbUJsb2NrLmJsb2NrTXV0YXRvci5zYXZlRXh0cmFTdGF0ZS5jYWxsKGN1c3RvbUJsb2NrLmJsb2NrTXV0YXRvcik7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbG9hZEV4dHJhU3RhdGU6IGZ1bmN0aW9uIChzdGF0ZTogYW55KSB7XG4gICAgICAgICAgICAgIGN1c3RvbUJsb2NrLmJsb2NrTXV0YXRvci5sb2FkRXh0cmFTdGF0ZS5jYWxsKGN1c3RvbUJsb2NrLmJsb2NrTXV0YXRvciwgc3RhdGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH07XG4gICAgICAgICAgaWYgKGN1c3RvbUJsb2NrLmJsb2NrTXV0YXRvci5ibG9ja0xpc3QgJiYgY3VzdG9tQmxvY2suYmxvY2tNdXRhdG9yLmJsb2NrTGlzdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBtdXRhdG9yX21peGluLmRlY29tcG9zZSA9IGZ1bmN0aW9uICh3b3Jrc3BhY2U6IGFueSkge1xuICAgICAgICAgICAgICByZXR1cm4gY3VzdG9tQmxvY2suYmxvY2tNdXRhdG9yLmRlY29tcG9zZS5jYWxsKGN1c3RvbUJsb2NrLmJsb2NrTXV0YXRvciwgdGhpcywgd29ya3NwYWNlKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBtdXRhdG9yX21peGluLmNvbXBvc2UgPSBmdW5jdGlvbiAodG9wQmxvY2s6IGFueSkge1xuICAgICAgICAgICAgICBjdXN0b21CbG9jay5ibG9ja011dGF0b3IuY29tcG9zZS5jYWxsKGN1c3RvbUJsb2NrLmJsb2NrTXV0YXRvciwgdGhpcywgdG9wQmxvY2spO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG11dGF0b3JfbWl4aW4uc2F2ZUNvbm5lY3Rpb25zID0gZnVuY3Rpb24gKGNvbnRhaW5lckJsb2NrOiBhbnkpIHtcbiAgICAgICAgICAgICAgY3VzdG9tQmxvY2suYmxvY2tNdXRhdG9yLnNhdmVDb25uZWN0aW9ucy5jYWxsKGN1c3RvbUJsb2NrLmJsb2NrTXV0YXRvciwgdGhpcywgY29udGFpbmVyQmxvY2spO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG4gICAgICAgICAgQmxvY2tseS5FeHRlbnNpb25zLnVucmVnaXN0ZXIoY3VzdG9tQmxvY2suYmxvY2tNdXRhdG9yLm5hbWUpO1xuICAgICAgICAgIEJsb2NrbHkuRXh0ZW5zaW9ucy5yZWdpc3Rlck11dGF0b3IoXG4gICAgICAgICAgICBjdXN0b21CbG9jay5ibG9ja011dGF0b3IubmFtZSxcbiAgICAgICAgICAgIG11dGF0b3JfbWl4aW4sXG4gICAgICAgICAgICBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgIGN1c3RvbUJsb2NrLmJsb2NrTXV0YXRvci5hZnRlckJsb2NrSW5pdC5jYWxsKGN1c3RvbUJsb2NrLmJsb2NrTXV0YXRvciwgdGhpcyk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgY3VzdG9tQmxvY2suYmxvY2tNdXRhdG9yLmJsb2NrTGlzdFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICBOZ3hCbG9ja2x5Q29tcG9uZW50LmluaXRDdXN0b21CbG9ja3ModGhpcy5jdXN0b21CbG9ja3MpO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIGNvbnN0IHJlYWRPbmx5ID0gdGhpcy5jb25maWcucmVhZE9ubHkgfHwgdGhpcy5yZWFkT25seTtcbiAgICB0aGlzLmNvbmZpZy5yZWFkT25seSA9IGZhbHNlO1xuICAgIHRoaXMud29ya3NwYWNlID0gQmxvY2tseS5pbmplY3QodGhpcy5wcmltYXJ5Q29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsIHRoaXMuY29uZmlnKTtcbiAgICB0aGlzLndvcmtzcGFjZS5hZGRDaGFuZ2VMaXN0ZW5lcih0aGlzLl9vbldvcmtzcGFjZUNoYW5nZS5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLndvcmtzcGFjZS5maXJlQ2hhbmdlTGlzdGVuZXIobmV3IEJsb2NrbHkuRXZlbnRzLkZpbmlzaGVkTG9hZGluZygpKTtcbiAgICB0aGlzLndvcmtzcGFjZUNyZWF0ZS5lbWl0KHRoaXMud29ya3NwYWNlKTtcbiAgICB0aGlzLnJlc2l6ZSgpO1xuICAgIGlmIChyZWFkT25seSkge1xuICAgICAgdGhpcy5zZXRSZWFkb25seSh0cnVlKTtcbiAgICAgIHRoaXMuY29uZmlnLnJlYWRPbmx5ID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiB7IFtwcm9wS2V5OiBzdHJpbmddOiBTaW1wbGVDaGFuZ2UgfSkge1xuICAgIC8vIHNraXAgdGhpcyBpZiB0aGUgY2hhbmdlIGNvbWVzIGJlZm9yZSB3ZSBhcmUgaW5pdGlhbGl6ZWRcbiAgICBpZiAoY2hhbmdlcy5yZWFkT25seSAmJiB0aGlzLl9zZWNvbmRhcnlXb3Jrc3BhY2UpIHtcbiAgICAgIHRoaXMuc2V0UmVhZG9ubHkoY2hhbmdlcy5yZWFkT25seS5jdXJyZW50VmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIGlmICh0aGlzLndvcmtzcGFjZSkge1xuICAgICAgdGhpcy53b3Jrc3BhY2UuZGlzcG9zZSgpO1xuICAgIH1cbiAgICBpZiAodGhpcy5fc2Vjb25kYXJ5V29ya3NwYWNlKSB7XG4gICAgICB0aGlzLl9zZWNvbmRhcnlXb3Jrc3BhY2UuZGlzcG9zZSgpO1xuICAgIH1cbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ3dpbmRvdzpyZXNpemUnLCBbJyRldmVudCddKVxuICBvblJlc2l6ZShldmVudCkge1xuICAgIGNsZWFyVGltZW91dCh0aGlzLl9yZXNpemVUaW1lb3V0KTtcbiAgICB0aGlzLl9yZXNpemVUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLnJlc2l6ZSgpLCAyMDApO1xuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlIGNvZGUgZm9yIGFsbCBibG9ja3MgaW4gdGhlIHdvcmtzcGFjZSB0byB0aGUgc3BlY2lmaWVkIG91dHB1dC5cbiAgICogQHBhcmFtIHdvcmtzcGFjZUlkIFdvcmtzcGFjZSB0byBnZW5lcmF0ZSBjb2RlIGZyb20uXG4gICAqL1xuICBwdWJsaWMgd29ya3NwYWNlVG9Db2RlKHdvcmtzcGFjZUlkOiBzdHJpbmcpIHtcbiAgICBmb3IgKGNvbnN0IGdlbmVyYXRvciBvZiB0aGlzLmNvbmZpZy5nZW5lcmF0b3JzKSB7XG4gICAgICBzd2l0Y2ggKGdlbmVyYXRvcikge1xuICAgICAgICBjYXNlIE5neEJsb2NrbHlHZW5lcmF0b3IuREFSVDpcbiAgICAgICAgICB0aGlzLmRhcnRDb2RlLmVtaXQoZGFydEdlbmVyYXRvci53b3Jrc3BhY2VUb0NvZGUoQmxvY2tseS5Xb3Jrc3BhY2UuZ2V0QnlJZCh3b3Jrc3BhY2VJZCkpKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBOZ3hCbG9ja2x5R2VuZXJhdG9yLkxVQTpcbiAgICAgICAgICB0aGlzLmx1YUNvZGUuZW1pdChsdWFHZW5lcmF0b3Iud29ya3NwYWNlVG9Db2RlKEJsb2NrbHkuV29ya3NwYWNlLmdldEJ5SWQod29ya3NwYWNlSWQpKSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgTmd4QmxvY2tseUdlbmVyYXRvci5KQVZBU0NSSVBUOlxuICAgICAgICAgIHRoaXMuamF2YXNjcmlwdENvZGUuZW1pdChqYXZhc2NyaXB0R2VuZXJhdG9yLndvcmtzcGFjZVRvQ29kZShCbG9ja2x5LldvcmtzcGFjZS5nZXRCeUlkKHdvcmtzcGFjZUlkKSkpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIE5neEJsb2NrbHlHZW5lcmF0b3IuUEhQOlxuICAgICAgICAgIHRoaXMucGhwQ29kZS5lbWl0KHBocEdlbmVyYXRvci53b3Jrc3BhY2VUb0NvZGUoQmxvY2tseS5Xb3Jrc3BhY2UuZ2V0QnlJZCh3b3Jrc3BhY2VJZCkpKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBOZ3hCbG9ja2x5R2VuZXJhdG9yLlBZVEhPTjpcbiAgICAgICAgICB0aGlzLnB5dGhvbkNvZGUuZW1pdChweXRob25HZW5lcmF0b3Iud29ya3NwYWNlVG9Db2RlKEJsb2NrbHkuV29ya3NwYWNlLmdldEJ5SWQod29ya3NwYWNlSWQpKSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgTmd4QmxvY2tseUdlbmVyYXRvci5YTUw6XG4gICAgICAgICAgdGhpcy54bWxDb2RlLmVtaXQoQmxvY2tseS5YbWwuZG9tVG9QcmV0dHlUZXh0KEJsb2NrbHkuWG1sLndvcmtzcGFjZVRvRG9tKEJsb2NrbHkuV29ya3NwYWNlLmdldEJ5SWQod29ya3NwYWNlSWQpKSkpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0cyBhIERPTSBzdHJ1Y3R1cmUgaW50byBwcm9wZXJseSBpbmRlbnRlZCB0ZXh0LlxuICAgKiBAcmV0dXJuIFRleHQgcmVwcmVzZW50YXRpb24uXG4gICAqL1xuICBwdWJsaWMgdG9YbWwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gQmxvY2tseS5YbWwuZG9tVG9QcmV0dHlUZXh0KEJsb2NrbHkuWG1sLndvcmtzcGFjZVRvRG9tKHRoaXMud29ya3NwYWNlKSk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgdGhlIGdpdmVuIHdvcmtzcGFjZSB0aGVuIGRlY29kZSBhbiBYTUwgRE9NIGFuZFxuICAgKiBjcmVhdGUgYmxvY2tzIG9uIHRoZSB3b3Jrc3BhY2UuXG4gICAqIEBwYXJhbSB4bWwgWE1MIERPTS4uXG4gICAqL1xuICBwdWJsaWMgZnJvbVhtbCh4bWw6IHN0cmluZykge1xuICAgIHRoaXMuX2ZpbmlzaGVkTG9hZGluZyA9IGZhbHNlO1xuICAgIEJsb2NrbHkuWG1sLmNsZWFyV29ya3NwYWNlQW5kTG9hZEZyb21YbWwoQmxvY2tseS5YbWwudGV4dFRvRG9tKHhtbCksIHRoaXMud29ya3NwYWNlKTtcbiAgICBpZiAodGhpcy5fc2Vjb25kYXJ5V29ya3NwYWNlKSB7XG4gICAgICBCbG9ja2x5LlhtbC5jbGVhcldvcmtzcGFjZUFuZExvYWRGcm9tWG1sKEJsb2NrbHkuWG1sLnRleHRUb0RvbSh4bWwpLCB0aGlzLl9zZWNvbmRhcnlXb3Jrc3BhY2UpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBEZWNvZGUgYW4gWE1MIERPTSBhbmQgY3JlYXRlIGJsb2NrcyBvbiB0aGUgd29ya3NwYWNlLiBQb3NpdGlvbiB0aGUgbmV3XG4gICAqIGJsb2NrcyBpbW1lZGlhdGVseSBiZWxvdyBwcmlvciBibG9ja3MsIGFsaWduZWQgYnkgdGhlaXIgc3RhcnRpbmcgZWRnZS5cbiAgICogQHBhcmFtIHhtbCBUaGUgWE1MIERPTS5cbiAgICovXG4gIHB1YmxpYyBhcHBlbmRGcm9tWG1sKHhtbDogc3RyaW5nKSB7XG4gICAgQmxvY2tseS5YbWwuYXBwZW5kRG9tVG9Xb3Jrc3BhY2UoQmxvY2tseS5YbWwudGV4dFRvRG9tKHhtbCksIHRoaXMud29ya3NwYWNlKTtcbiAgICBpZiAodGhpcy5fc2Vjb25kYXJ5V29ya3NwYWNlKSB7XG4gICAgICBCbG9ja2x5LlhtbC5hcHBlbmREb21Ub1dvcmtzcGFjZShCbG9ja2x5LlhtbC50ZXh0VG9Eb20oeG1sKSwgdGhpcy5fc2Vjb25kYXJ5V29ya3NwYWNlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRGlzcG9zZSBvZiBhbGwgYmxvY2tzIGluIHdvcmtzcGFjZSwgd2l0aCBhbiBvcHRpbWl6YXRpb24gdG8gcHJldmVudCByZXNpemVzLlxuICAgKi9cbiAgcHVibGljIGNsZWFyKCkge1xuICAgIGlmICh0aGlzLndvcmtzcGFjZSkge1xuICAgICAgdGhpcy53b3Jrc3BhY2UuY2xlYXIoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgdGhlIHVuZG8vcmVkbyBzdGFja3MuXG4gICAqL1xuICBwdWJsaWMgY2xlYXJVbmRvKCkge1xuICAgIGlmICh0aGlzLndvcmtzcGFjZSkge1xuICAgICAgdGhpcy53b3Jrc3BhY2UuY2xlYXJVbmRvKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENsZWFyIHRoZSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgZ2VzdHVyZS5cbiAgICovXG4gIHB1YmxpYyBjbGVhckdlc3R1cmUoKSB7XG4gICAgaWYgKHRoaXMud29ya3NwYWNlKSB7XG4gICAgICB0aGlzLndvcmtzcGFjZS5jbGVhckdlc3R1cmUoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgc2VhcmNoIGlucHV0IGFuZCByZXN1bHQgc2V0LlxuICAgKi9cbiAgcHVibGljIGNsZWFyU2VhcmNoKCkge1xuICAgIGlmICh0aGlzLndvcmtzcGFjZSkge1xuICAgICAgY29uc3QgdG9vbGJveCA9IHRoaXMud29ya3NwYWNlLmdldFRvb2xib3goKSBhcyBOZ3hCbG9ja2x5VG9vbGJveDtcbiAgICAgIGlmICh0b29sYm94ICYmIHR5cGVvZiB0b29sYm94LmNsZWFyU2VhcmNoID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIHRvb2xib3guY2xlYXJTZWFyY2goKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2l6ZSB0aGUgd29ya3NwYWNlIHdoZW4gdGhlIGNvbnRlbnRzIGNoYW5nZS4gVGhpcyBhbHNvIHVwZGF0ZXNcbiAgICogc2Nyb2xsYmFycyBhY2NvcmRpbmdseS5cbiAgICovXG4gIHB1YmxpYyByZXNpemUoKSB7XG4gICAgaWYgKHRoaXMud29ya3NwYWNlKSB7XG4gICAgICBCbG9ja2x5LnN2Z1Jlc2l6ZSh0aGlzLndvcmtzcGFjZSk7XG4gICAgfVxuICAgIGlmICh0aGlzLl9zZWNvbmRhcnlXb3Jrc3BhY2UpIHtcbiAgICAgIEJsb2NrbHkuc3ZnUmVzaXplKHRoaXMuX3NlY29uZGFyeVdvcmtzcGFjZSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNldFJlYWRvbmx5KHJlYWRPbmx5OiBib29sZWFuKSB7XG4gICAgdGhpcy5yZWFkT25seSA9IHJlYWRPbmx5O1xuICAgIGlmIChyZWFkT25seSkge1xuICAgICAgdGhpcy5zZWNvbmRhcnlDb250YWluZXIubmF0aXZlRWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCdoaWRkZW4nKTtcbiAgICAgIGlmICghdGhpcy5fc2Vjb25kYXJ5V29ya3NwYWNlKSB7XG4gICAgICAgIGNvbnN0IGNvbmZpZyA9IHsgLi4udGhpcy5jb25maWcgfTtcbiAgICAgICAgY29uZmlnLnJlYWRPbmx5ID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5fc2Vjb25kYXJ5V29ya3NwYWNlID0gQmxvY2tseS5pbmplY3QodGhpcy5zZWNvbmRhcnlDb250YWluZXIubmF0aXZlRWxlbWVudCwgY29uZmlnKTtcbiAgICAgIH1cbiAgICAgIEJsb2NrbHkuWG1sLmNsZWFyV29ya3NwYWNlQW5kTG9hZEZyb21YbWwoQmxvY2tseS5YbWwudGV4dFRvRG9tKHRoaXMudG9YbWwoKSksIHRoaXMuX3NlY29uZGFyeVdvcmtzcGFjZSk7XG4gICAgICBCbG9ja2x5LnN2Z1Jlc2l6ZSh0aGlzLl9zZWNvbmRhcnlXb3Jrc3BhY2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5fc2Vjb25kYXJ5V29ya3NwYWNlKSB7XG4gICAgICAgIHRoaXMuc2Vjb25kYXJ5Q29udGFpbmVyLm5hdGl2ZUVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnaGlkZGVuJyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGhpZ2hsaWdodEJsb2NrKGJsb2NrSWQ6IHN0cmluZykge1xuICAgIGlmICh0aGlzLndvcmtzcGFjZSkge1xuICAgICAgdGhpcy53b3Jrc3BhY2UuaGlnaGxpZ2h0QmxvY2soYmxvY2tJZCk7XG4gICAgfVxuICAgIGlmICh0aGlzLl9zZWNvbmRhcnlXb3Jrc3BhY2UpIHtcbiAgICAgIHRoaXMuX3NlY29uZGFyeVdvcmtzcGFjZS5oaWdobGlnaHRCbG9jayhibG9ja0lkKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9vbldvcmtzcGFjZUNoYW5nZShldmVudDogYW55KSB7XG4gICAgdGhpcy53b3Jrc3BhY2VDaGFuZ2UuZW1pdChldmVudCk7XG4gICAgaWYgKGV2ZW50LnR5cGUgPT09IEJsb2NrbHkuRXZlbnRzLkZJTklTSEVEX0xPQURJTkcpIHtcbiAgICAgIHRoaXMuX2ZpbmlzaGVkTG9hZGluZyA9IHRydWU7XG4gICAgfVxuICAgIGlmICh0aGlzLl9maW5pc2hlZExvYWRpbmcpIHtcbiAgICAgIGlmIChldmVudCBpbnN0YW5jZW9mIEJsb2NrbHkuRXZlbnRzLkJsb2NrQmFzZSB8fFxuICAgICAgICBldmVudCBpbnN0YW5jZW9mIEJsb2NrbHkuRXZlbnRzLlZhckJhc2UgfHxcbiAgICAgICAgZXZlbnQgaW5zdGFuY2VvZiBCbG9ja2x5LkV2ZW50cy5Db21tZW50QmFzZSkge1xuICAgICAgICB0aGlzLndvcmtzcGFjZVRvQ29kZShldmVudC53b3Jrc3BhY2VJZCk7XG4gICAgICB9XG4gICAgICBpZiAoZXZlbnQudHlwZSA9PT0gQmxvY2tseS5FdmVudHMuVE9PTEJPWF9JVEVNX1NFTEVDVCkge1xuICAgICAgICB0aGlzLnRvb2xib3hDaGFuZ2UuZW1pdChldmVudCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iLCI8ZGl2IGlkPVwiYmxvY2tseS13cmFwcGVyXCIgY2xhc3M9XCJibG9ja2x5LXdyYXBwZXJcIj5cbiAgICA8ZGl2ICNwcmltYXJ5Q29udGFpbmVyIGNsYXNzPVwiYmxvY2tseVwiPjwvZGl2PlxuICAgIDxkaXYgI3NlY29uZGFyeUNvbnRhaW5lciBjbGFzcz1cImJsb2NrbHkgaGlkZGVuXCI+PC9kaXY+XG48L2Rpdj5cbiJdfQ==